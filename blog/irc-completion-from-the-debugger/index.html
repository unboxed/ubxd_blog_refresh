<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>IRB completion from the debugger</title>
    <link href="../../assets/stylesheets/application.css" rel="stylesheet" type="text/css" />
    <script src="../../assets/javascripts/application.js" type="text/javascript"></script>
  </head>

  <body class="blog blog_irc-completion-from-the-debugger blog_irc-completion-from-the-debugger_index">
    <header class="site-header">
      <div class="site-header__container">
        <div class="site-header__brand">
          Unboxed
        </div>
        <div class="site-header__page-title">
          Blog
        </div>
      </div>
    </header>

    <div class="blog-wrap">
      <div class="blog-article">
        <article class="blog-article__container">
          <div class="blog-article__header">
            <p class="blog-article__author">
              Tom ten Thij
            </p>

            <p class="blog-article__published-date" id="articlePublishedDate" data-date="2010-08-18 11:09:00 UTC">
              <span>
                18 Aug 2010
              </span>
            </p>
            <script type="text/javascript">
              date = document.querySelector('#articlePublishedDate').getAttribute('data-date');
              document.querySelector('#articlePublishedDate span').outerHTML = moment(new Date(date)).fromNow();
            </script>
          </div>


          <h1 class="blog-article__title">
            IRB completion from the debugger
          </h1>

          <div class="blog-article__content">
            <p>The default IRB completion code that ships with Ruby does not work well when being invoked from the debugger prompt: <script src="http://gist.github.com/534983.js?file=debugger_blowup" type="text/javascript"></script></p>

<noscript> 
<pre><code>
&gt;: ruby /test_script.rb 
[-2, 7] in /test_script.rb
   1 require 'ruby-debug'
   2 debugger
=&gt; 3 :foo
/test_script.rb:3
:foo
(rdb:1) INTERNAL ERROR!!! undefined method `workspace' for nil:NilClass
        /System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/ruby/1.8/irb/completion.rb:38
        /Users/tomtt/.gem/ruby/1.8/gems/ruby-debug-0.10.3/cli/ruby-debug/interface.rb:112:in `call'
        /Users/tomtt/.gem/ruby/1.8/gems/ruby-debug-0.10.3/cli/ruby-debug/interface.rb:112:in `readline'
        /Users/tomtt/.gem/ruby/1.8/gems/ruby-debug-0.10.3/cli/ruby-debug/interface.rb:112:in `readline'
        /Users/tomtt/.gem/ruby/1.8/gems/ruby-debug-0.10.3/cli/ruby-debug/interface.rb:62:in `read_command'
        /Users/tomtt/.gem/ruby/1.8/gems/ruby-debug-0.10.3/cli/ruby-debug/processor.rb:246:in `process_commands'
        /Users/tomtt/.gem/ruby/1.8/gems/ruby-debug-0.10.3/cli/ruby-debug/processor.rb:171:in `__at_line'
        (eval):5:in `at_line'
        (eval):3:in `synchronize'
        (eval):3:in `at_line'
        /Users/tomtt/.gem/ruby/1.8/gems/ruby-debug-base-0.10.3/lib/ruby-debug-base.rb:54:in `at_line'
        /test_script.rb:3
</code></pre> 
</noscript>

<p>The reason why this happens is that the completion code assumes that IRB.conf[:MAIN_CONTEXT] is defined, but this is not the case when debugger is used. All we are really after is a valid binding, so to patch we can just use self.binding when the irb context is not available. An example patch can be found on my <a href="http://github.com/tomtt/ruby/commit/03a0a6d905cc610349b3e7fdf0cf157abd475edb">fork of an unofficial ruby repository</a>.</p>

<p>In these days where rvm allows multiple ruby versions to be used, patching is not a patch-once-and-forget issue any longer. Therefore I felt the need to write a utility for this. It checks if your current version of ruby is patched and if not, shows the filename that needs to be updated and the suggest code change. It is bundled as the patch_irb_completion gem: simply &ldquo;gem install patch_irb_completion;patch_irb_completion&rdquo;. But that gives the overhead of having to install a gem for every ruby version. So maybe an executable script is a better solution. Here is one: <script src="http://gist.github.com/535032.js?file=patch_irb_completion" type="text/javascript"></script></p>

<noscript> 
<pre><code>
#!/usr/bin/env ruby

require 'find'

module PatchIRBCompletion
  class Suggest
    def self.find_ruby_lib_path
      ruby_bin_path = `which ruby`
      ruby_path = File.expand_path(File.join(ruby_bin_path, "..", "..", "lib"))
      unless File.exist?(ruby_path)
        ruby_path = `ruby -e "puts $:[0]"`
      end
    end

    def self.find_completion_source_in_dir(dir)
      Find.find(dir) do |filename|
        # puts filename
        next unless File.basename(filename) == "completion.rb"
        return filename
      end
      nil
    end

    def self.find_completion_source_in_current_ruby_version
      $:.each do |lib_dir|
        completion_file = find_completion_source_in_dir(lib_dir)
        next unless completion_file
        return completion_file
      end
    end

    def self.check_if_completion_source_file_has_offending_code(filename)
      unpatched_code = "IRB.conf[:MAIN_CONTEXT].workspace"
      File.read(filename).include?(unpatched_code)
    end

    def self.call
      filename = find_completion_source_in_current_ruby_version
      if check_if_completion_source_file_has_offending_code(filename)
        puts </code></pre> 
</noscript>

<p>Here is some example output: <script src="http://gist.github.com/535081.js?file=patch_irb_completion" type="text/javascript"></script></p>

<noscript> 
<pre><code>
&gt;: patch_irb_completion 
The file "/Users/tomtt/.rvm/rubies/ruby-1.9.2-rc2/lib/ruby/1.9.1/irb/completion.rb" has not been patched... I would suggest you replace:
    bind = IRB.conf[:MAIN_CONTEXT].workspace.binding (line 38)
with:
    context = IRB.conf[:MAIN_CONTEXT]
    bind = context ? context.workspace.binding : binding
</code></pre> 
</noscript>

          </div>

          <div class="disqus-thread" id="disqus_thread"></div>
          <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES * * */
            var disqus_shortname = 'unboxedconsulting';
            // var disqus_identifier = '81b9f768-1dc6-466a-8a9c-fed33921e0a3'; // migration required to add this
            var disqus_url = 'https://www.unboxedconsulting.com/blog/irc-completion-from-the-debugger';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        </article>
      </div>

      <aside class="blog-info">
        <section class="blog-info__section blog-author">
          <div class="blog-author__header">
            <img class="blog-author__image" src="/assets/images/caricatures/graeme-mccubbin.png" alt="blog author"/>
            <p class="blog-author__name">
              <span>About Graeme</span>
            </p>
          </div>
          <div class="blog-author__bio">
            Iâ€™m Graeme, the Marketing Co-ordinator here at Unboxed Consulting. I'm passionate about communication and all things digital. Never afraid to be creative - who knows where it might lead? In my free time, I love to explore and enjoy cooking up a storm in the kitchen.
          </div>
        </section>


        <section class="blog-info__section blog-related">
          <p class="blog-related__header">Related reading</p>
          <ul>
            <li class="blog-related__links"><a href="/blog/ubxddev-vol-39/">UBXDDEV Vol. 3.9</a></li>

            <li class="blog-related__links"><a href="/blog/the-squish-of-the-week/">The squish of the week</a></li>

            <li class="blog-related__links"><a href="/blog/cape-town-curator/">Happy Ashes!</a></li>

            <li class="blog-related__links"><a href="/blog/what-s-there-to-know-about-outsourcing/">What is there to know about outsourcing?</a></li>
          </ul>
        </section>
      </aside>

    </div>
  </body>

  <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,600' rel='stylesheet' type='text/css'>
</html>
