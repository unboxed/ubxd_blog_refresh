<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>The abominable Rails 3 snowman doesn't like Rack-Test</title>
    <link href="../../assets/stylesheets/application.css" rel="stylesheet" type="text/css" />
    <script src="../../assets/javascripts/application.js" type="text/javascript"></script>
  </head>

  <body class="blog blog_rails-3-snowman-9731-and-rack-test blog_rails-3-snowman-9731-and-rack-test_index">
    <header class="site-header">
      <div class="site-header__container">
        <div class="site-header__brand">
          Unboxed
        </div>
        <div class="site-header__page-title">
          Blog
        </div>
      </div>
    </header>

    <div class="blog-wrap">
      <div class="blog-article">
        <article class="blog-article__container">
          <div class="blog-article__header">
            <p class="blog-article__author">
              Alan Kennedy
            </p>

            <p class="blog-article__published-date" id="articlePublishedDate" data-date="2010-08-10 00:00:00 UTC">
              <span>
                10 Aug 2010
              </span>
            </p>
            <script type="text/javascript">
              date = document.querySelector('#articlePublishedDate').getAttribute('data-date');
              document.querySelector('#articlePublishedDate span').outerHTML = moment(new Date(date)).fromNow();
            </script>
          </div>


          <h1 class="blog-article__title">
            The abominable Rails 3 snowman doesn't like Rack-Test
          </h1>

          <div class="blog-article__content">
            <p>I recently started a Rails 3 application to see how things are done in the new version, and also to take an opportunity to try Mongoid. After all, Rails now plays nicely with any library that implements&nbsp;ActiveModel.</p>

<p>&nbsp;</p>

<p>The application is very basic, with normal CRUD and file uploads; but after upgrading the&nbsp;application from Rails 3 beta 4 to the Release Candidate I found that a Cucumber feature for uploading files was broken.</p>

<p>To do the file uploads I am using MongoFS, which is part of Mongo and deals with binary files in the DB; Carrierwave to handle the uploads in Rails (a nice ORM agnostic replacement for Paperclip); and Capybara with rack-test for acceptance testing. This all worked without problems in beta 4. So when Cucumber broke after upgrading I started investigating: uploading was still possible in development but Cucumber would fail with an encoding error (the application runs with Ruby 1.9.2) and no meaningful backtrace.</p>

<p>**incompatible character encodings: UTF-8 and ASCII-8BIT (Encoding::CompatibilityError)  </p>

<p>./features/step_definitions/web_steps.rb:29:in `block (2 levels) in <top (required)>&rsquo;  </p>

<p>./features/step_definitions/web_steps.rb:14:in `with_scope&rsquo;**</p>

<p>After a while using the debugger, I tracked the problem in Rack-Test, which is not escaping the parameters that are part of multipart body. This is a big problem in Rails 3 RC because it sends the _snowman parameter with value ☃ (a unicode character) and an encoding error happens in Rack-Test. To those curious as to the reason behind the snowman, it&rsquo;s there to enforce the encoding in Internet Explorer. The parameter was renamed to _e a couple of days ago, I guess in honour of Internet Explorer&hellip; The reasons for the&nbsp;☃ are well explained in its own dedicated page <a href="http://railssnowman.info/">here</a>&nbsp;and also&nbsp; <a href="http://github.com/rails/rails/commit/25215d7285db10e2c04d903f251b791342e4dd6a#commitcomment-118076">here</a>.</p>

<p>I&rsquo;ve submitted a bug <a href="http://github.com/brynary/rack-test/issues#issue/14">report</a> for this in rack-test github issues, and am waiting for my fix to be merged. So if you have come across this problem and want to get your Cucumber tests working go ahead and use my <a href="http://github.com/alan/rack-test">fork</a> in your Gemfile until this is fixed, and also comment on the bug report so this gets merged soon. Hopefully Google will index this blog post and help other early adopters with the same problem.</p>

<p>One last thing, in cases like this where Cucumber backtraces are not enough, you can run Cucumber with -b / &ndash;backtrace parameter to show normal backtraces. Knowing this woud have saved me time in the debugger.</p>

<p>At least now tailing the logs will be a bit more fun with the&nbsp;☃ appearing on every request!</p>

          </div>

          <div class="disqus-thread" id="disqus_thread"></div>
          <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES * * */
            var disqus_shortname = 'unboxedconsulting';
            // var disqus_identifier = '81b9f768-1dc6-466a-8a9c-fed33921e0a3'; // migration required to add this
            var disqus_url = 'https://www.unboxedconsulting.com/blog/rails-3-snowman-9731-and-rack-test';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        </article>
      </div>

      <aside class="blog-info">
        <section class="blog-info__section blog-author">
          <div class="blog-author__header">
            <img class="blog-author__image" src="/assets/images/caricatures/graeme-mccubbin.png" alt="blog author"/>
            <p class="blog-author__name">
              <span>About Graeme</span>
            </p>
          </div>
          <div class="blog-author__bio">
            I’m Graeme, the Marketing Co-ordinator here at Unboxed Consulting. I'm passionate about communication and all things digital. Never afraid to be creative - who knows where it might lead? In my free time, I love to explore and enjoy cooking up a storm in the kitchen.
          </div>
        </section>


        <section class="blog-info__section blog-related">
          <p class="blog-related__header">Related reading</p>
          <ul>
            <li class="blog-related__links"><a href="/blog/feature-based-benefits/">Feature-based Benefits</a></li>

            <li class="blog-related__links"><a href="/blog/happy-new-year-unboxedians/">Happy New Year Unboxedians and commiserations on the ashes</a></li>

            <li class="blog-related__links"><a href="/blog/mobilising-your-brand-web-vs-native-apps/">Mobilising your brand - mobile web vs native apps</a></li>

            <li class="blog-related__links"><a href="/blog/gemnastics-with-activerecord/">Gemnastics with ActiveRecord</a></li>
          </ul>
        </section>
      </aside>

    </div>
  </body>

  <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,600' rel='stylesheet' type='text/css'>
</html>
